---
title: "How to combine data from Open Tree of Life and GBIF"
author: "Emily Jane McTavish"
date: "`r Sys.Date()`"
vignette: |
  %\VignetteIndexEntry{How to get trees from OpenTree and combine them with GBIF location data.} %\VignetteEngine{knitr::rmarkdown} \usepackage[utf8]{inputenc}
---
For background complete the introductory tutorials on rgbif and on rotl to familiarize yourself.  
https://ropensci.org/tutorials/rotl_tutorial/  
https://ropensci.org/tutorials/rgbif_tutorial/  

# Combining evolutionary and geographic information
In order to examine geographic distributions of species, it is useful to tie together information about phylogenetic relationships, which we can get from Open Tree of Life, with information about where individuals of that species are found.

### Install and load necessary packages

```{r message=FALSE, warning=FALSE}
install.packages("devtools")
library(devtools)
install_github("liamrevell/phytools")
#We are using the newest github version of phytools because it has some cool mapping updates that are not yet avaiable in the cran version (as of March 12, 2019).
library(phytools)
library(httr)
library(jsonlite)
library(rgbif)
library(rotl)
library(viridis)
```


### Choose some species
Lets look for some fun species, 
A polar bear, "Ursus maritimus", a hippo "Hippopotamus amphibius", a gorilla "Gorilla gorilla" and a wild boar "Sus scrofa".

```{r}
polarbear <-"Ursus maritimus"
hippo <-"Hippopotamus amphibius"
boar <-"Sus scrofa"
gorilla <- "Gorilla gorilla"
spp <- c(polarbear, boar, gorilla, hippo)
```

### We can use Open Tree of Life to generate a tree for our species!  
![](OpenTree-final-logo-copy.png)

First we match the names to species in the OpenTree database. Specifying the context of the names makes the search faster.    
```{r message=FALSE, warning=FALSE}
taxa <- tnrs_match_names(spp, context="Animals")
taxa
```

Then we get the relationships between these species from the OpenTree synthetic tree. 
(See the whole tree at [tree.opentreeoflife.org](tree.opentreeoflife.org)!)  
```{r  message=FALSE, warning=FALSE}
tr <- tol_induced_subtree(ott_id(taxa), label="name")
plot(tr)
```

### Don't forget to cite the studies that went into building your tree!
Pulling supporting studies isn't included in rotl yet (or I couldn't find it).
So we will use an Open Tree API call directly.

```{r}
url_ot <- 'https://api.opentreeoflife.org/v3/tree_of_life/induced_subtree'
body <- list(ott_ids=taxa$ott_id)
r <- POST(url_ot, body = body, encode = "json")#gets which studies support the subtree from  the open tree API
for(tree in content(r)$supporting_studies){
study <- strsplit(tree,'@')[[1]][1]
meta <- get_study_meta(study) #pulls the metadata for each study
pub <- get_publication(meta)  #grabs teh publication information
cat(pub,"\n\n")
}
```

# Lets combine the phylogenetic information from Open Tree with geographic information from GBIF

We will use the Global Biodiversity Information Facility (GBIF) to search for locations of records of these species. Check out https://www.gbif.org/ to see tons more cool information!  

```{r}
dat1 <- occ_search(scientificName = polarbear, fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 5)
dat2 <- occ_search(scientificName =hippo, fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 5)
dat3 <- occ_search(scientificName = boar,  fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 5)
dat4 <- occ_search(scientificName = gorilla, fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 5)
locs <- as.data.frame(rbind(dat1$data,dat2$data, dat3$data, dat4$data)) #Combine the data from each species
locs[,1] <- gsub(' ','_',locs[,1])# enforce newick style tip names, by replacing spaces with underscores
#Sometimes the lat longs have spaces in the records. 
#We use trimws to get rid of the whitespace, and as.numeric to encode them as numbers instead of characters.
locs[,2]<-as.numeric(trimws(as.character(locs[,2])))
locs[,3]<-as.numeric(trimws(as.character(locs[,3])))
latlong <- as.matrix(locs[,c(3,2)]) #flip the columns to lat, long instead of long,lat
rownames(latlong) <- locs[,1]
```


Check that your species are all included and have the correct names (taxonomic name recognition sometimes updates them)
```{r}
latlong
```


## Now to join together the geographic information with the phylogenetic information!
Trees from OpenTree don't automatically come with branch lengths - we need to infer some branch lengths for this tree in order to plot it. (in future we can use R-Datelife to get the ages! [datelife.org](datelife.org))

```{r}
tr_bl<-compute.brlen(tr)
```

Combine the phylogeny and the mapped locations using phytools.
Thank you to Liam Revell for help getting this working!
```{r, fig.height=4, fig.width=7}
cols<-setNames(sample(viridis(n=Ntip(tr_bl))),
    tr_bl$tip.label)
tdobj<-phylo.to.map(tr_bl,latlong,plot = FALSE, direction="rightwards")
plot(tdobj, colors=cols, direction="rightwards")
```



# We can do a better job of name matching by actually using the cross taxonomy mappings already encoded in the Open Tree Taxonomy!

### Lets try it some plants

```{r messages=F, warning=F, eval=TRUE}
plants <- c("Mimulous guttatus","Arabidopsis thaliana", "Musa gracilis", "Carex capitata")
plant_taxa <- tnrs_match_names(plants)
plant_tree <- tol_induced_subtree(ott_id(plant_taxa), label="name")
plant_tree_bl<-compute.brlen(plant_tree)
```

## One of these species is not what we searched for!
```{r}
plot(plant_tree)
```

Mimulus guttatus is a synonym of Erythranthe lutea 
https://tree.opentreeoflife.org/taxonomy/browse?id=662909

```{r}
plant_taxa
```
Because we will mapping tips based on unique identifiers instead of names, the name replacement doesn't affect our mapping


## We can write a function to search for a GBIF identifier using the OpenTree ID for each taxon.
```{r}
get_gbif_id<-function(ottid){
   tax_info <- taxonomy_taxon_info(as.integer(ottid))
   gbif_id = NA
   for(source in tax_info[[1]]$tax_sources){
     if (grepl('gbif', source, fixed=TRUE)){
            gbif_id <- strsplit(source,":")[[1]][2]
     }}
     return(gbif_id)
   }
``` 

Once we have the gbif ID, we can seach for location records using that ID
```{r}
plant_locs<- NULL
for(ottid in plant_taxa$ott_id){
   gbif_id <- get_gbif_id(ottid)
   result <- occ_search(taxonKey = gbif_id, fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 2)
   if (dim(result$data)[2]==3){#drops records with no data at all
      plant_locs<-as.data.frame(rbind(plant_locs, result$data))
   }
}

#some tidying to make the input in the correct format for phytools
plant_locs<-na.omit(plant_locs) #remove records with NA
plant_locs[,1] <- gsub(' ','_',plant_locs[,1])# enforce newick style tip names, by replacing spaces with underscores
#Sometimes the lat longs have spaces in the records. 
#We use trimws to get rid of the whitespace, and as.numeric to encode them as numbers instead of characters.
plant_locs[,2]<-as.numeric(trimws(as.character(plant_locs[,2])))
plant_locs[,3]<-as.numeric(trimws(as.character(plant_locs[,3])))
plant_latlong <- as.matrix(plant_locs[,c(3,2)]) #flip the columns to lat, long instead of long,lat
rownames(plant_latlong) <- plant_locs[,1]
```

```{r}
cols<-setNames(sample(viridis(n=Ntip(plant_tree_bl))),plant_tree_bl$tip.label)
plant_tdobj<-phylo.to.map(plant_tree_bl,plant_latlong, plot = FALSE, direction = "rightwards")
plot(plant_tdobj, colors=cols, direction="rightwards")
```


## Sometimes we don't have locations for all of our species
Lets look at fairy shrimp species from the UC Merced vernal pools reserve

```{r}
shrimp_spp <- c("Branchinecta conservatio","Branchinecta lynchi","Branchinecta mesovallensis","Linderiella occidentalis","Lepidurus packardi","Cyzicus californicus")
shrimp_taxa <- tnrs_match_names(shrimp_spp, context="Animals")
shrimp_tr <- tol_induced_subtree(ott_id(shrimp_taxa), label="name")
shrimp_tr_bl<-compute.brlen(shrimp_tr)

shrimp_locs <-NULL
for(ottid in shrimp_taxa$ott_id){
    gbif_id <- get_gbif_id(ottid)
    result <- occ_search(taxonKey = gbif_id, fields=c('name','decimalLatitude', 'decimalLongitude'), limit = 20)
    if (dim(result$data)[2]==3){#drops records with no data at all
       shrimp_locs<-as.data.frame(rbind(shrimp_locs, result$data))
    }
}

#some tidying to make the input in the correct format for phytools
shrimp_locs<-na.omit(shrimp_locs) #remove records with NA
shrimp_locs[,1] <- gsub(' ','_',shrimp_locs[,1])# enforce newick style tip names, by replacing spaces with underscores
#Sometimes the lat longs have spaces in the records. 
#We use trimws to get rid of the whitespace, and as.numeric to encode them as numbers instead of characters.
shrimp_locs[,2]<-as.numeric(trimws(as.character(shrimp_locs[,2])))
shrimp_locs[,3]<-as.numeric(trimws(as.character(shrimp_locs[,3])))
shrimp_latlong <- as.matrix(shrimp_locs[,c(3,2)]) #flip the columns to lat, long instead of long,lat
rownames(shrimp_latlong) <- shrimp_locs[,1]
unique(shrimp_locs[,1])
shrimp_tr$tip.label
```
```{r}
species<-unique(shrimp_locs[,1])
#we can use the -match (the negative sign makes mean NOT match) operator to drop any tips from our tree that don't match species we have locations for
prunedtree<-drop.tip(shrimp_tr_bl,shrimp_tr_bl$tip.label[-match(species, shrimp_tr_bl$tip.label)])

cols<-setNames(sample(viridis(n=Ntip(prunedtree))),prunedtree$tip.label)
shrimp_tdobj<-phylo.to.map(prunedtree,shrimp_latlong, plot = FALSE, direction = "rightwards")
plot(shrimp_tdobj, colors=cols, direction="rightwards")
```
# Wow! Pretty resticted ranges :)
